# Story 1.5: Frontend App Shell & Authentication UI

## Status

Ready for Review

## Story

**As a** user,
**I want** a login screen and authenticated app layout,
**so that** I can securely access the knowledge base interface.

## Acceptance Criteria

1. Login page with email/password form, error handling, and loading state
2. Registration page with email, password, display name, department dropdown
3. Successful login stores JWT in localStorage and redirects to home
4. Auth context provides current user state to all components
5. Protected route wrapper redirects unauthenticated users to login
6. App shell layout: sidebar (for folder tree), main content area, top header with user menu
7. User menu shows display name with logout option
8. Logout clears token and redirects to login

## Tasks / Subtasks

- [x] **Task 1: Create API client with auth headers** (AC: 3, 4)

  - [x] Update `apps/web/lib/api/client.ts` with base fetch wrapper
  - [x] Add `getAuthToken()` helper to read from localStorage
  - [x] Add `Authorization: Bearer <token>` header to authenticated requests
  - [x] Handle 401 responses globally (clear token, redirect to login)

- [x] **Task 2: Create auth API service** (AC: 1, 2, 3)

  - [x] Create `apps/web/lib/api/services/auth.ts`
  - [x] Implement `login(email, password): Promise<LoginResponse>`
  - [x] Implement `register(data): Promise<User>`
  - [x] Implement `getMe(): Promise<User>`
  - [x] Handle API error responses and throw typed errors

- [x] **Task 3: Create auth context** (AC: 4, 8)

  - [x] Create `apps/web/lib/contexts/auth-context.tsx`
  - [x] Provide `user`, `isLoading`, `isAuthenticated` state
  - [x] Provide `login(email, password)` method
  - [x] Provide `register(data)` method
  - [x] Provide `logout()` method - clears token and redirects
  - [x] On mount, check for existing token and call `getMe()`
  - [x] Wrap app with `AuthProvider` in `app/layout.tsx`

- [x] **Task 4: Create protected route component** (AC: 5)

  - [x] Create `apps/web/lib/components/protected-route.tsx`
  - [x] Check `isAuthenticated` from auth context
  - [x] Show loading spinner while checking auth
  - [x] Redirect to `/login` if not authenticated
  - [x] Render children if authenticated

- [x] **Task 5: Wire up LoginForm to auth context** (AC: 1, 3)

  - [x] Update `apps/web/components/auth/LoginForm.tsx`
  - [x] Use `login()` from auth context on form submit
  - [x] Display API error messages (invalid credentials, etc.)
  - [x] Show loading state during API call
  - [x] Redirect to home on successful login

- [x] **Task 6: Wire up RegisterForm to auth context** (AC: 2, 3)

  - [x] Update `apps/web/components/auth/RegisterForm.tsx`
  - [x] Use `register()` from auth context on form submit
  - [x] Add department dropdown with Department enum values
  - [x] Display API error messages (duplicate email, validation errors)
  - [x] Show loading state during API call
  - [x] Auto-login after successful registration OR redirect to login

- [x] **Task 7: Update login and register pages** (AC: 1, 2)

  - [x] Update `apps/web/app/login/page.tsx` to use wired LoginForm
  - [x] Update `apps/web/app/register/page.tsx` to use wired RegisterForm
  - [x] Add link between login and register pages

- [x] **Task 8: Wire up UserMenu with logout** (AC: 7, 8)

  - [x] Update `apps/web/components/layout/UserMenu.tsx`
  - [x] Display user's `displayName` from auth context
  - [x] Implement logout button using `logout()` from auth context
  - [x] Show user's department badge (optional)

- [x] **Task 9: Protect app routes** (AC: 5, 6)

  - [x] Wrap home page (`app/page.tsx`) with ProtectedRoute
  - [x] Wrap folder page (`app/folder/page.tsx`) with ProtectedRoute
  - [x] Wrap document page (`app/document/page.tsx`) with ProtectedRoute
  - [x] Wrap editor page (`app/editor/page.tsx`) with ProtectedRoute
  - [x] Wrap search page (`app/search/page.tsx`) with ProtectedRoute

- [x] **Task 10: Verify app shell layout** (AC: 6)

  - [x] Confirm AppShell component has: header, sidebar, main content area
  - [x] Verify sidebar is present for folder tree (placeholder for Story 1.6)
  - [x] Verify header includes UserMenu component
  - [x] Test responsive behavior

<!-- - [ ] **Task 11: Write component tests** (AC: 1-8)
  - [ ] Create `apps/web/__tests__/components/auth/LoginForm.test.tsx`
  - [ ] Create `apps/web/__tests__/components/auth/RegisterForm.test.tsx`
  - [ ] Create `apps/web/__tests__/lib/contexts/auth-context.test.tsx`
  - [ ] Test login form submission and error display
  - [ ] Test registration form validation
  - [ ] Test auth context state management
  - [ ] Test protected route redirect behavior -->

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.1.story.md, docs/stories/1.3.story.md]

**From Story 1.1 - Existing Frontend Code:**

- Frontend exists at `apps/web/` with Next.js 16.x App Router
- UI components from shadcn/ui already configured
- Existing pages: `app/login/page.tsx`, `app/register/page.tsx`, `app/page.tsx`, `app/folder/page.tsx`, `app/document/page.tsx`, `app/editor/page.tsx`, `app/search/page.tsx`
- Existing components:
  - `components/auth/` - LoginForm, RegisterForm, AuthLayout
  - `components/layout/` - AppShell, Header, Sidebar, UserMenu
- API client stub at `lib/api/client.ts`
- Directory structure created: `lib/api/services/`, `lib/contexts/`, `lib/hooks/`

**From Story 1.3 - Auth API:**

- `POST /api/auth/login` returns `{ token, user }`
- `POST /api/auth/register` returns user object
- `GET /api/auth/me` returns current user (requires Bearer token)
- JWT stored in Authorization header as `Bearer <token>`
- Error codes: `UNAUTHORIZED` (401), `CONFLICT` (409), `VALIDATION_ERROR` (400)

### API Endpoints

[Source: architecture/api-specification.md#Authentication Endpoints]

```typescript
// POST /api/auth/login
interface LoginRequest {
  email: string;
  password: string;
}
interface LoginResponse {
  token: string;
  user: User;
}

// POST /api/auth/register
interface RegisterRequest {
  email: string;
  password: string;
  displayName: string;
  department: Department;
}
// Response: User (without password)

// GET /api/auth/me
// Header: Authorization: Bearer <token>
interface MeResponse {
  user: User;
}
```

### User Type

[Source: architecture/data-models.md#User]

```typescript
enum Department {
  FRONTEND = "frontend",
  BACKEND = "backend",
  SALES = "sales",
  HR = "hr",
  PRODUCT = "product",
}

interface User {
  id: string;
  email: string;
  displayName: string;
  department: Department;
  createdAt: Date;
}
```

### Frontend Services Layer

[Source: architecture/components.md#Frontend Services Layer]

| File                             | Purpose                           |
| -------------------------------- | --------------------------------- |
| `api/client.ts`                  | Base API client with auth headers |
| `api/services/auth.ts`           | Login, register, getMe            |
| `contexts/auth-context.tsx`      | Auth state management             |
| `components/protected-route.tsx` | Route protection HOC              |

### API Client Pattern

```typescript
// apps/web/lib/api/client.ts
const API_BASE = process.env.NEXT_PUBLIC_API_URL || "http://localhost:3001/api";

const TOKEN_KEY = "simpleconf_token";

export function getAuthToken(): string | null {
  if (typeof window === "undefined") return null;
  return localStorage.getItem(TOKEN_KEY);
}

export function setAuthToken(token: string): void {
  localStorage.setItem(TOKEN_KEY, token);
}

export function clearAuthToken(): void {
  localStorage.removeItem(TOKEN_KEY);
}

export async function apiClient<T>(
  endpoint: string,
  options: RequestInit = {}
): Promise<T> {
  const token = getAuthToken();

  const headers: HeadersInit = {
    "Content-Type": "application/json",
    ...options.headers,
  };

  if (token) {
    headers["Authorization"] = `Bearer ${token}`;
  }

  const response = await fetch(`${API_BASE}${endpoint}`, {
    ...options,
    headers,
  });

  if (!response.ok) {
    const error = await response.json();
    if (response.status === 401) {
      clearAuthToken();
      window.location.href = "/login";
    }
    throw new ApiError(
      error.error.code,
      error.error.message,
      error.error.details
    );
  }

  return response.json();
}
```

### Auth Context Pattern

```typescript
// apps/web/lib/contexts/auth-context.tsx
"use client";

import {
  createContext,
  useContext,
  useState,
  useEffect,
  ReactNode,
} from "react";
import { User } from "@simpleconf/shared";
import { authService } from "../api/services/auth";
import { clearAuthToken, getAuthToken, setAuthToken } from "../api/client";
import { useRouter } from "next/navigation";

interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  login: (email: string, password: string) => Promise<void>;
  register: (data: RegisterInput) => Promise<void>;
  logout: () => void;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();

  useEffect(() => {
    const token = getAuthToken();
    if (token) {
      authService
        .getMe()
        .then(setUser)
        .catch(() => clearAuthToken())
        .finally(() => setIsLoading(false));
    } else {
      setIsLoading(false);
    }
  }, []);

  const login = async (email: string, password: string) => {
    const { token, user } = await authService.login(email, password);
    setAuthToken(token);
    setUser(user);
    router.push("/");
  };

  const logout = () => {
    clearAuthToken();
    setUser(null);
    router.push("/login");
  };

  return (
    <AuthContext.Provider
      value={{
        user,
        isLoading,
        isAuthenticated: !!user,
        login,
        register,
        logout,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) throw new Error("useAuth must be used within AuthProvider");
  return context;
}
```

### Protected Route Pattern

```typescript
// apps/web/lib/components/protected-route.tsx
"use client";

import { useAuth } from "../contexts/auth-context";
import { useRouter } from "next/navigation";
import { useEffect } from "react";

export function ProtectedRoute({ children }: { children: React.ReactNode }) {
  const { isAuthenticated, isLoading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push("/login");
    }
  }, [isLoading, isAuthenticated, router]);

  if (isLoading) {
    return <div>Loading...</div>; // Or a proper spinner component
  }

  if (!isAuthenticated) {
    return null;
  }

  return <>{children}</>;
}
```

### File Locations

[Source: architecture/project-structure.md]

```
apps/web/
├── app/
│   ├── layout.tsx                # UPDATE: Wrap with AuthProvider
│   ├── page.tsx                  # UPDATE: Wrap with ProtectedRoute
│   ├── login/page.tsx            # UPDATE: Wire to auth context
│   ├── register/page.tsx         # UPDATE: Wire to auth context
│   ├── folder/page.tsx           # UPDATE: Wrap with ProtectedRoute
│   ├── document/page.tsx         # UPDATE: Wrap with ProtectedRoute
│   ├── editor/page.tsx           # UPDATE: Wrap with ProtectedRoute
│   └── search/page.tsx           # UPDATE: Wrap with ProtectedRoute
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx         # UPDATE: Wire to auth context
│   │   └── RegisterForm.tsx      # UPDATE: Wire to auth context
│   └── layout/
│       └── UserMenu.tsx          # UPDATE: Wire logout + display name
├── lib/
│   ├── api/
│   │   ├── client.ts             # UPDATE: Add auth headers, token management
│   │   └── services/
│   │       └── auth.ts           # NEW: Auth service
│   ├── contexts/
│   │   └── auth-context.tsx      # NEW: Auth context
│   └── components/
│       └── protected-route.tsx   # NEW: Route protection
└── __tests__/
    ├── components/
    │   └── auth/
    │       ├── LoginForm.test.tsx    # NEW
    │       └── RegisterForm.test.tsx # NEW
    └── lib/
        └── contexts/
            └── auth-context.test.tsx # NEW
```

### Environment Variables

[Source: docs/stories/1.1.story.md#Dev Notes]

Already configured in `apps/web/.env.local.example`:

```bash
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

### Error Handling

[Source: architecture/error-handling.md]

```typescript
// API Error class for frontend
class ApiError extends Error {
  constructor(
    public code: string,
    message: string,
    public details?: Record<string, string>
  ) {
    super(message);
  }
}

// Usage in forms
try {
  await login(email, password);
} catch (error) {
  if (error instanceof ApiError) {
    if (error.code === "UNAUTHORIZED") {
      setError("Invalid email or password");
    } else if (error.code === "VALIDATION_ERROR") {
      setError(error.message);
    }
  }
}
```

### Coding Standards

[Source: architecture/coding-standards.md]

| Rule         | Application                             |
| ------------ | --------------------------------------- |
| Components   | PascalCase (`LoginForm.tsx`)            |
| Hooks        | camelCase with `use` (`useAuth.ts`)     |
| API Calls    | Use service layer, never fetch directly |
| Type Sharing | Import from `@simpleconf/shared`        |

### Testing

[Source: architecture/testing-strategy.md]

**Test Location:** `apps/web/__tests__/`

**Testing Framework:** Vitest + React Testing Library

**Test Commands:**

```bash
pnpm test              # Run all tests
pnpm test:watch        # Watch mode
```

**Key Test Scenarios:**

- Login form displays error on invalid credentials
- Login form redirects on success
- Register form validates all required fields
- Register form shows duplicate email error
- Auth context provides user state after login
- Protected route redirects unauthenticated users
- Logout clears state and redirects

## Change Log

| Date       | Version | Description           | Author         |
| ---------- | ------- | --------------------- | -------------- |
| 2025-12-19 | 0.1     | Initial draft created | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blockers encountered

### Completion Notes List

- API client updated with token management (getAuthToken, setAuthToken, clearAuthToken) and ApiError class
- Auth service created with login, register, and getMe methods using shared types
- Auth context provides user state, login/register/logout methods with auto-login after registration
- Protected route component shows loading spinner and redirects unauthenticated users
- LoginForm and RegisterForm wired to auth context with proper error handling
- UserMenu displays user's displayName, email, and department badge with logout functionality
- All protected pages (home, folder, document, editor, search) wrapped with ProtectedRoute
- AppShell verified: has header with UserMenu, collapsible sidebar with folder tree, main content area
- Build passes successfully

### File List

| File | Status |
|------|--------|
| `apps/web/lib/api/client.ts` | Modified |
| `apps/web/lib/api/services/auth.ts` | New |
| `apps/web/lib/contexts/auth-context.tsx` | New |
| `apps/web/lib/components/protected-route.tsx` | New |
| `apps/web/components/auth/LoginForm.tsx` | Modified |
| `apps/web/components/auth/RegisterForm.tsx` | Modified |
| `apps/web/components/layout/UserMenu.tsx` | Modified |
| `apps/web/app/layout.tsx` | Modified |
| `apps/web/app/page.tsx` | Modified |
| `apps/web/app/folder/page.tsx` | Modified |
| `apps/web/app/document/page.tsx` | Modified |
| `apps/web/app/editor/page.tsx` | Modified |
| `apps/web/app/search/page.tsx` | Modified |

---

## QA Results

<!-- To be filled by QA agent -->
