# Story 1.3: User Authentication API

## Status

Approved

## Story

**As a** user,
**I want** to register and log in with email/password,
**so that** I can access the knowledge base securely.

## Acceptance Criteria

1. `POST /api/auth/register` accepts email, password, display_name, department; returns user object (no password)
2. `POST /api/auth/login` accepts email, password; returns JWT token on success
3. Passwords hashed with bcrypt (cost factor 10+)
4. JWT tokens include user id, email, department; expire in 24 hours
5. `GET /api/auth/me` returns current user when valid JWT provided in Authorization header
6. Invalid credentials return 401 with appropriate error message
7. Duplicate email registration returns 409 Conflict
8. Input validation for email format and password minimum length (8 chars)

## Tasks / Subtasks

- [ ] **Task 1: Install authentication dependencies** (AC: 3, 4)
  - [ ] Add `bcrypt` and `@types/bcrypt` to `apps/api/package.json`
  - [ ] Add `@fastify/jwt` for JWT support
  - [ ] Add `zod` for request validation (if not already installed)

- [ ] **Task 2: Configure JWT plugin** (AC: 4)
  - [ ] Create `apps/api/src/plugins/jwt.ts` with Fastify JWT configuration
  - [ ] Update `apps/api/src/config/env.ts` to include `JWT_SECRET` validation
  - [ ] Register JWT plugin in `apps/api/src/app.ts`
  - [ ] Set token expiration to 24 hours

- [ ] **Task 3: Create authentication middleware** (AC: 5, 6)
  - [ ] Create `apps/api/src/middleware/authenticate.ts`
  - [ ] Extract and verify JWT from `Authorization: Bearer <token>` header
  - [ ] Attach decoded user to request object
  - [ ] Return 401 with `UNAUTHORIZED` error code for invalid/missing tokens

- [ ] **Task 4: Create Zod validation schemas** (AC: 8)
  - [ ] Create `packages/shared/src/schemas/auth.ts` with validation schemas
  - [ ] `registerSchema`: email (valid format), password (min 8 chars), displayName, department
  - [ ] `loginSchema`: email, password
  - [ ] Export schemas from `packages/shared/src/schemas/index.ts`
  - [ ] Rebuild shared package

- [ ] **Task 5: Create user repository** (AC: 1, 2, 7)
  - [ ] Create `apps/api/src/repositories/user.repository.ts`
  - [ ] Implement `findByEmail(email: string): Promise<UserWithPassword | null>`
  - [ ] Implement `findById(id: string): Promise<User | null>`
  - [ ] Implement `create(data: CreateUserData): Promise<User>`
  - [ ] Implement `emailExists(email: string): Promise<boolean>`

- [ ] **Task 6: Create auth service** (AC: 1, 2, 3, 4, 6, 7)
  - [ ] Create `apps/api/src/services/auth.service.ts`
  - [ ] Implement `register(data): Promise<User>` - hash password, check duplicate, create user
  - [ ] Implement `login(email, password): Promise<{ token, user }>` - verify credentials, generate JWT
  - [ ] Implement `hashPassword(password): Promise<string>` - bcrypt with cost 10
  - [ ] Implement `verifyPassword(password, hash): Promise<boolean>`

- [ ] **Task 7: Create auth module routes** (AC: 1, 2, 5, 6, 7, 8)
  - [ ] Create `apps/api/src/modules/auth/auth.routes.ts`
  - [ ] `POST /auth/register` - validate input, call service, return user (no password)
  - [ ] `POST /auth/login` - validate input, call service, return token + user
  - [ ] `GET /auth/me` - require auth middleware, return current user
  - [ ] Create `apps/api/src/modules/auth/index.ts` to export routes
  - [ ] Register auth routes in `apps/api/src/app.ts` with `/api` prefix

- [ ] **Task 8: Create API response types** (AC: 1, 2, 5)
  - [ ] Create `packages/shared/src/types/api.ts` for API response types
  - [ ] Define `ApiError` interface
  - [ ] Define `LoginResponse`, `RegisterResponse`, `MeResponse` interfaces
  - [ ] Export from shared package

- [ ] **Task 9: Write unit tests** (AC: 1-8)
  - [ ] Create `apps/api/tests/unit/services/auth.service.test.ts`
  - [ ] Test password hashing produces valid bcrypt hash
  - [ ] Test password verification works correctly
  - [ ] Test register throws on duplicate email

- [ ] **Task 10: Write integration tests** (AC: 1-8)
  - [ ] Create `apps/api/tests/integration/auth.test.ts`
  - [ ] Test `POST /auth/register` creates user and returns without password
  - [ ] Test `POST /auth/register` returns 409 for duplicate email
  - [ ] Test `POST /auth/register` returns 400 for invalid input
  - [ ] Test `POST /auth/login` returns JWT for valid credentials
  - [ ] Test `POST /auth/login` returns 401 for invalid credentials
  - [ ] Test `GET /auth/me` returns user for valid token
  - [ ] Test `GET /auth/me` returns 401 for missing/invalid token

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.2.story.md]

Story 1.2 establishes:
- Drizzle ORM configured with PostgreSQL connection
- Users table with `id`, `email`, `password_hash`, `display_name`, `department`, `created_at`
- User types defined in `packages/shared/src/types/user.ts`
- Department enum: `frontend`, `backend`, `sales`, `hr`, `product`
- Repository pattern for database access
- Database plugin registered in Fastify app

### API Specification

[Source: architecture/api-specification.md#Authentication Endpoints]

**Base URL:** `http://localhost:3001/api`

| Method | Endpoint | Purpose | Auth Required |
|--------|----------|---------|---------------|
| POST | `/auth/register` | Create new user account | No |
| POST | `/auth/login` | Authenticate and get JWT | No |
| GET | `/auth/me` | Get current user profile | Yes |

**Request/Response Types:**

```typescript
// POST /auth/register
interface RegisterRequest {
  email: string;
  password: string;      // Min 8 characters
  displayName: string;
  department: Department;
}
// Response: User object (without password)

// POST /auth/login
interface LoginRequest {
  email: string;
  password: string;
}
interface LoginResponse {
  token: string;         // JWT, expires in 24h
  user: User;
}

// GET /auth/me
// Header: Authorization: Bearer <token>
interface MeResponse {
  user: User;
}
```

### Error Handling

[Source: architecture/error-handling.md]

**Error Response Format:**
```typescript
interface ApiError {
  error: {
    code: string;       // VALIDATION_ERROR, UNAUTHORIZED, CONFLICT, etc.
    message: string;
    details?: Record<string, string>;
  }
}
```

**Relevant Error Codes:**

| Code | HTTP Status | Usage |
|------|-------------|-------|
| VALIDATION_ERROR | 400 | Invalid email format, password < 8 chars |
| UNAUTHORIZED | 401 | Invalid credentials, missing/invalid token |
| CONFLICT | 409 | Duplicate email registration |

### Security Requirements

[Source: architecture/security-and-performance.md]

| Aspect | Implementation |
|--------|----------------|
| Password Storage | bcrypt (cost factor 10+) |
| Input Validation | Zod schemas on all endpoints |

### JWT Configuration

[Source: architecture/tech-stack.md]

- **Library:** `@fastify/jwt`
- **Token Expiration:** 24 hours
- **Token Payload:** `{ id, email, department }`
- **Header Format:** `Authorization: Bearer <token>`

**JWT Plugin Setup:**
```typescript
// apps/api/src/plugins/jwt.ts
import fastifyJwt from '@fastify/jwt';

export async function jwtPlugin(fastify: FastifyInstance) {
  fastify.register(fastifyJwt, {
    secret: fastify.config.JWT_SECRET,
    sign: {
      expiresIn: '24h',
    },
  });
}
```

### Validation Schemas

[Source: architecture/api-specification.md]

```typescript
// packages/shared/src/schemas/auth.ts
import { z } from 'zod';
import { Department } from '../types/user';

export const registerSchema = z.object({
  email: z.string().email('Invalid email format'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
  displayName: z.string().min(1, 'Display name is required'),
  department: z.nativeEnum(Department),
});

export const loginSchema = z.object({
  email: z.string().email('Invalid email format'),
  password: z.string().min(1, 'Password is required'),
});

export type RegisterInput = z.infer<typeof registerSchema>;
export type LoginInput = z.infer<typeof loginSchema>;
```

### File Locations

[Source: architecture/project-structure.md]

```
apps/api/src/
├── config/
│   └── env.ts                    # UPDATE: Add JWT_SECRET
├── plugins/
│   ├── database.ts               # EXISTS from Story 1.2
│   └── jwt.ts                    # NEW: JWT plugin
├── middleware/
│   └── authenticate.ts           # NEW: Auth middleware
├── repositories/
│   └── user.repository.ts        # NEW: User DB operations
├── services/
│   └── auth.service.ts           # NEW: Auth business logic
├── modules/
│   └── auth/
│       ├── index.ts              # NEW: Module export
│       └── auth.routes.ts        # NEW: Route handlers
└── app.ts                        # UPDATE: Register plugins/routes

apps/api/tests/
├── unit/
│   └── services/
│       └── auth.service.test.ts  # NEW
└── integration/
    └── auth.test.ts              # NEW

packages/shared/src/
├── types/
│   ├── user.ts                   # EXISTS from Story 1.2
│   └── api.ts                    # NEW: API response types
├── schemas/
│   ├── index.ts                  # UPDATE: Export auth schemas
│   └── auth.ts                   # NEW: Validation schemas
└── index.ts                      # UPDATE: Export new modules
```

### Environment Variables

[Source: architecture/development-workflow.md]

Add to `apps/api/.env.example`:
```bash
JWT_SECRET=your-secret-key-at-least-32-characters
```

Update `apps/api/src/config/env.ts`:
```typescript
export const envSchema = {
  type: 'object',
  required: ['DATABASE_URL', 'JWT_SECRET'],
  properties: {
    DATABASE_URL: { type: 'string' },
    JWT_SECRET: { type: 'string', minLength: 32 },
    PORT: { type: 'number', default: 3001 },
    // ...
  },
};
```

### Coding Standards

[Source: architecture/coding-standards.md]

| Rule | Application |
|------|-------------|
| API Routes | kebab-case (`/auth/register`) |
| Type Sharing | All types in `@simpleconf/shared` |
| Database | Repository pattern |
| Authentication | Always use `authenticate` middleware for protected routes |

### Testing

[Source: architecture/testing-strategy.md]

**Test Locations:**
- Unit tests: `apps/api/tests/unit/services/auth.service.test.ts`
- Integration tests: `apps/api/tests/integration/auth.test.ts`

**Testing Framework:** Vitest

**Test Commands:**
```bash
pnpm test              # Run all tests
pnpm test:watch        # Watch mode
```

**Required Test Coverage:**
- Unit: Password hashing/verification, duplicate email check
- Integration: All 3 endpoints with success and error cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 0.1 | Initial draft created | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

<!-- To be filled by dev agent -->

### Debug Log References

<!-- To be filled by dev agent -->

### Completion Notes List

<!-- To be filled by dev agent -->

### File List

<!-- To be filled by dev agent -->

---

## QA Results

<!-- To be filled by QA agent -->
