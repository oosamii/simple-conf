# Story 1.2: Database Schema & Migrations

## Status

Ready for Review

## Story

**As a** developer,
**I want** the core database schema for users, folders, and documents,
**so that** the application can persist and retrieve knowledge base data.

## Acceptance Criteria

1. PostgreSQL database connection established from backend
2. Migration system configured (Drizzle ORM)
3. `users` table: id, email, password_hash, display_name, department, created_at
4. `folders` table: id, name, parent_id (nullable for root), department, visibility, created_by, created_at
5. `documents` table: id, title, content (text), folder_id, created_by, modified_by, view_count, created_at, updated_at
6. Foreign key constraints properly defined
7. Seed script creates sample department folders (Frontend, Backend, Sales, HR, Product)
8. Database can be reset and re-seeded via pnpm script

## Tasks / Subtasks

- [x] **Task 1: Install Drizzle ORM and PostgreSQL dependencies** (AC: 1, 2)
  - [x] Add `drizzle-orm` and `postgres` (pg driver) to `apps/api/package.json`
  - [x] Add `drizzle-kit` as dev dependency for migrations
  - [x] Create `drizzle.config.ts` at `apps/api/` root

- [x] **Task 2: Configure database connection** (AC: 1)
  - [x] Create `apps/api/src/db/index.ts` with Drizzle client initialization
  - [x] Update `apps/api/src/config/env.ts` to include `DATABASE_URL` validation
  - [x] Create database connection plugin at `apps/api/src/plugins/database.ts`
  - [x] Register database plugin in `apps/api/src/app.ts`

- [x] **Task 3: Define shared types and enums** (AC: 3, 4, 5)
  - [x] Create `packages/shared/src/types/user.ts` with `User`, `Department` enum
  - [x] Create `packages/shared/src/types/folder.ts` with `Folder`, `FolderVisibility` type
  - [x] Create `packages/shared/src/types/document.ts` with `Document` interface
  - [x] Export all types from `packages/shared/src/types/index.ts`
  - [x] Rebuild shared package

- [x] **Task 4: Create Drizzle schema definitions** (AC: 3, 4, 5, 6)
  - [x] Create `apps/api/src/db/schema/users.ts` with users table definition
  - [x] Create `apps/api/src/db/schema/folders.ts` with folders table definition
  - [x] Create `apps/api/src/db/schema/documents.ts` with documents table definition
  - [x] Create `apps/api/src/db/schema/index.ts` to export all schemas
  - [x] Define foreign key relationships between tables

- [x] **Task 5: Generate and run initial migration** (AC: 2)
  - [x] Add `db:generate` script to `apps/api/package.json`
  - [x] Add `db:migrate` script to `apps/api/package.json`
  - [x] Run `pnpm db:generate` to create migration files in `apps/api/drizzle/`
  - [ ] Run `pnpm db:migrate` to apply migration to database (skipped - Docker/PostgreSQL not available)

- [x] **Task 6: Create seed script** (AC: 7, 8)
  - [x] Create `apps/api/src/db/seed.ts` with sample data
  - [x] Create admin user for seeding (password hashed with bcrypt)
  - [x] Create root folders for each department: Frontend, Backend, Sales, HR, Product
  - [x] Add `db:seed` script to `apps/api/package.json`

- [x] **Task 7: Create database reset script** (AC: 8)
  - [x] Add `db:reset` script that drops, migrates, and seeds
  - [x] Add root-level pnpm scripts: `db:migrate`, `db:seed`, `db:reset`

- [x] **Task 8: Write integration tests** (AC: 1-8)
  - [x] Create `apps/api/tests/integration/database.test.ts`
  - [x] Test database connection establishment
  - [x] Test migration applies without errors
  - [x] Test seed script creates expected data
  - [x] Test foreign key constraints work correctly

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.1.story.md#Dev Agent Record]

- Monorepo structure established with pnpm workspaces
- Backend at `apps/api/` with Fastify 5.x running on port 3001
- Shared package `@simpleconf/shared` configured for cross-project imports
- Directory structure already created: `apps/api/src/db/`, `apps/api/drizzle/`
- Vitest testing infrastructure in place at `apps/api/tests/`
- Docker Compose configured with PostgreSQL 16 + pgvector on port 5432
- Database credentials: `simpleconf:simpleconf`, database name: `simpleconf`

### Tech Stack

[Source: architecture/tech-stack.md]

| Component | Technology | Version |
|-----------|------------|---------|
| ORM | Drizzle ORM | Latest |
| Database | PostgreSQL | 16+ |
| Vector Extension | pgvector | 0.7+ |
| Authentication (future) | bcrypt | - |

### Database Schema

[Source: architecture/database-schema.md]

**Required Extensions:**
```sql
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgvector";
```

**Department Enum Values:**
```typescript
'frontend' | 'backend' | 'sales' | 'hr' | 'product'
```

**Folder Visibility Enum:**
```typescript
'public' | 'department'
```

**Users Table Schema:**
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  department department NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_users_email ON users(email);
```

**Folders Table Schema:**
```sql
CREATE TABLE folders (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  parent_id UUID REFERENCES folders(id) ON DELETE CASCADE,
  department department,
  visibility folder_visibility NOT NULL DEFAULT 'public',
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(parent_id, name)
);
CREATE INDEX idx_folders_parent ON folders(parent_id);
CREATE INDEX idx_folders_department ON folders(department);
```

**Documents Table Schema:**
```sql
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title VARCHAR(500) NOT NULL,
  content TEXT NOT NULL,
  folder_id UUID NOT NULL REFERENCES folders(id) ON DELETE CASCADE,
  created_by UUID NOT NULL REFERENCES users(id),
  modified_by UUID REFERENCES users(id),
  view_count INTEGER NOT NULL DEFAULT 0,
  embedding vector(384),           -- For future semantic search
  indexed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
CREATE INDEX idx_documents_folder ON documents(folder_id);
CREATE INDEX idx_documents_view_count ON documents(view_count DESC);
CREATE INDEX idx_documents_updated ON documents(updated_at DESC);
```

### Data Models (TypeScript)

[Source: architecture/data-models.md]

**User Type:**
```typescript
// packages/shared/src/types/user.ts
export enum Department {
  FRONTEND = 'frontend',
  BACKEND = 'backend',
  SALES = 'sales',
  HR = 'hr',
  PRODUCT = 'product',
}

export interface User {
  id: string;
  email: string;
  displayName: string;
  department: Department;
  createdAt: Date;
}

export interface UserWithPassword extends User {
  passwordHash: string;
}

export type PublicUser = Pick<User, 'id' | 'displayName' | 'department'>;
```

**Folder Type:**
```typescript
// packages/shared/src/types/folder.ts
export type FolderVisibility = 'public' | 'department';

export interface Folder {
  id: string;
  name: string;
  parentId: string | null;
  department: Department | null;
  visibility: FolderVisibility;
  createdBy: string;
  createdAt: Date;
}
```

**Document Type:**
```typescript
// packages/shared/src/types/document.ts
export interface Document {
  id: string;
  title: string;
  content: string;
  folderId: string;
  createdBy: string;
  modifiedBy: string | null;
  viewCount: number;
  createdAt: Date;
  updatedAt: Date;
}
```

### File Locations

[Source: architecture/project-structure.md]

```
apps/api/
├── src/
│   ├── config/
│   │   └── env.ts              # Add DATABASE_URL
│   ├── plugins/
│   │   └── database.ts         # NEW: DB connection plugin
│   └── db/
│       ├── index.ts            # NEW: Drizzle client
│       ├── schema/
│       │   ├── index.ts        # NEW: Export all schemas
│       │   ├── users.ts        # NEW: Users table
│       │   ├── folders.ts      # NEW: Folders table
│       │   └── documents.ts    # NEW: Documents table
│       └── seed.ts             # NEW: Seed script
├── drizzle/
│   └── migrations/             # Generated migration files
└── drizzle.config.ts           # NEW: Drizzle kit config

packages/shared/src/types/
├── index.ts                    # UPDATE: Export new types
├── user.ts                     # NEW: User types
├── folder.ts                   # NEW: Folder types
└── document.ts                 # NEW: Document types
```

### Drizzle Configuration

[Source: architecture/tech-stack.md, architecture/development-workflow.md]

**drizzle.config.ts:**
```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/db/schema/index.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
} satisfies Config;
```

**Package.json scripts to add:**
```json
{
  "scripts": {
    "db:generate": "drizzle-kit generate",
    "db:migrate": "drizzle-kit migrate",
    "db:seed": "tsx src/db/seed.ts",
    "db:reset": "drizzle-kit drop && pnpm db:migrate && pnpm db:seed"
  }
}
```

### Coding Standards

[Source: architecture/coding-standards.md]

| Rule | Application |
|------|-------------|
| Database Tables | snake_case (e.g., `password_hash`, `created_at`) |
| TypeScript Types | PascalCase (e.g., `User`, `Document`) |
| Type Sharing | All types in `@simpleconf/shared` |
| Database Access | Repository pattern |
| Environment | Access via `env.ts`, never `process.env` directly |

### Environment Variables

[Source: architecture/development-workflow.md]

Already configured in `apps/api/.env.example`:
```bash
DATABASE_URL=postgresql://simpleconf:simpleconf@localhost:5432/simpleconf
```

### Testing

[Source: architecture/testing-strategy.md]

**Test Location:** `apps/api/tests/integration/database.test.ts`

**Testing Framework:** Vitest

**Test Commands:**
```bash
pnpm test              # Run all tests
pnpm test:watch        # Watch mode
```

**Required Tests:**
- Database connection test
- Migration application test
- Seed data verification test
- Foreign key constraint test

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 0.1 | Initial draft created | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None required - no blocking issues encountered.

### Completion Notes List

- All Drizzle ORM and PostgreSQL dependencies installed successfully
- Database connection configured with Fastify plugin pattern
- Shared types created in `@simpleconf/shared` package for cross-project use
- Drizzle schema definitions created for users, folders, and documents tables
- Migration file generated successfully (`0000_sad_the_fury.sql`)
- Migration application skipped - Docker/PostgreSQL not available on local machine
- Seed script creates admin user (admin@simpleconf.local / admin123) and 5 department folders
- Reset script drops all tables, runs migrations, and seeds data
- Integration tests written for database connection, schema verification, seed data, and FK constraints
- TypeScript compiles without errors
- Note: Integration tests require a running PostgreSQL instance to execute

### File List

**New Files:**
- `apps/api/drizzle.config.ts` - Drizzle Kit configuration
- `apps/api/src/db/index.ts` - Drizzle client initialization
- `apps/api/src/db/seed.ts` - Database seeding script
- `apps/api/src/db/reset.ts` - Database reset script
- `apps/api/src/db/schema/index.ts` - Schema exports
- `apps/api/src/db/schema/users.ts` - Users table definition
- `apps/api/src/db/schema/folders.ts` - Folders table definition
- `apps/api/src/db/schema/documents.ts` - Documents table definition
- `apps/api/src/plugins/database.ts` - Fastify database plugin
- `apps/api/drizzle/0000_sad_the_fury.sql` - Initial migration
- `apps/api/tests/integration/database.test.ts` - Database integration tests
- `packages/shared/src/types/user.ts` - User and Department types
- `packages/shared/src/types/folder.ts` - Folder and FolderVisibility types
- `packages/shared/src/types/document.ts` - Document type

**Modified Files:**
- `apps/api/package.json` - Added dependencies and db:generate script
- `apps/api/src/app.ts` - Registered database plugin
- `packages/shared/src/types/index.ts` - Added exports for new types

### Change Log

| Date | Change | Files |
|------|--------|-------|
| 2025-12-19 | Installed drizzle-orm, postgres, drizzle-kit, bcrypt, fastify-plugin | apps/api/package.json |
| 2025-12-19 | Created Drizzle configuration | apps/api/drizzle.config.ts |
| 2025-12-19 | Created database connection module and plugin | apps/api/src/db/index.ts, apps/api/src/plugins/database.ts |
| 2025-12-19 | Created shared types for User, Folder, Document | packages/shared/src/types/*.ts |
| 2025-12-19 | Created Drizzle schema definitions | apps/api/src/db/schema/*.ts |
| 2025-12-19 | Generated initial migration | apps/api/drizzle/0000_sad_the_fury.sql |
| 2025-12-19 | Created seed and reset scripts | apps/api/src/db/seed.ts, apps/api/src/db/reset.ts |
| 2025-12-19 | Created integration tests | apps/api/tests/integration/database.test.ts |

---

## QA Results

<!-- To be filled by QA agent -->
