# Story 1.6: Folder Tree Navigation

## Status

Ready for Review

## Story

**As a** user,
**I want** to browse the folder hierarchy in a sidebar,
**so that** I can navigate to documents by department and category.

## Acceptance Criteria

1. Folder tree component displays hierarchical folder structure
2. Folders are collapsible/expandable with visual indicator (chevron)
3. Clicking a folder shows its contents in the main area (subfolders + documents list)
4. Document count displayed next to each folder name (e.g., "PRDs (7)")
5. Current folder highlighted in tree
6. Document list shows title, last updated date, and owner name
7. Clicking a document navigates to document view
8. Empty folder shows "No documents yet" message with create button

## Tasks / Subtasks

- [x] **Task 1: Create folder API service** (AC: 1, 3)

  - [x] Create `apps/web/lib/api/services/folders.ts`
  - [x] Implement `getFolderTree(): Promise<FolderTreeNode[]>` - calls `GET /api/folders`
  - [x] Implement `getFolderDetails(id: string): Promise<FolderDetailResponse>` - calls `GET /api/folders/:id`
  - [x] Export service from `apps/web/lib/api/services/index.ts`

- [x] **Task 2: Create document API service** (AC: 6, 7)

  - [x] Create `apps/web/lib/api/services/documents.ts`
  - [x] Implement `getDocument(id: string): Promise<DocumentWithMeta>` - calls `GET /api/documents/:id`
  - [x] Implement `createDocument(data: CreateDocumentInput): Promise<Document>` - calls `POST /api/documents`
  - [x] Export service from `apps/web/lib/api/services/index.ts`

- [x] **Task 3: Update FolderTree component** (AC: 1, 2, 3, 4, 5)

  - [x] Update `apps/web/components/folder/FolderTree.tsx`
  - [x] Update `FolderNode` interface to match `FolderTreeNode` from `@simpleconf/shared`
  - [x] Add `onFolderSelect(folderId: string)` callback prop
  - [x] Add click handler on folder name to trigger navigation (not just expand/collapse)
  - [x] Ensure chevron click only toggles expand/collapse
  - [x] Use `documentCount` field for badge (rename from `count`)
  - [x] Apply current folder highlight based on `currentFolderId` prop

- [x] **Task 4: Update Sidebar component** (AC: 1, 3, 5)

  - [x] Update `apps/web/components/layout/Sidebar.tsx`
  - [x] Remove hardcoded mock folder data
  - [x] Fetch folder tree from API using `folderService.getFolderTree()` on mount
  - [x] Add loading state (skeleton or spinner)
  - [x] Add error state with retry option
  - [x] Pass `onFolderSelect` callback to navigate using Next.js router
  - [x] Track and pass `currentFolderId` from URL params

- [x] **Task 5: Update DocumentList component** (AC: 6, 7)

  - [x] Update `apps/web/components/folder/DocumentList.tsx`
  - [x] Change `Document` interface `id` from `number` to `string`
  - [x] Update interface to match `DocumentSummary` from `@simpleconf/shared`:
    - `id: string`, `title: string`, `updatedAt: Date`, `createdBy: PublicUser`, `viewCount: number`
  - [x] Update `selectedId` prop from `number | null` to `string | null`
  - [x] Format `updatedAt` date using relative time (e.g., "2 days ago")
  - [x] Display `createdBy.displayName` as owner
  - [x] Display `viewCount` for views

- [x] **Task 6: Update Breadcrumbs component** (AC: 3)

  - [x] Update `apps/web/components/folder/Breadcrumbs.tsx`
  - [x] Change props to accept `breadcrumbs: { id: string; name: string }[]` from API
  - [x] Add click handlers to navigate to folder by ID
  - [x] Keep "Home" as first item linking to root (`/folder`)

- [x] **Task 7: Update folder page with API integration** (AC: 1, 3, 4, 5, 6, 7, 8)

  - [x] Update `apps/web/app/folder/page.tsx`
  - [x] Accept `folderId` from URL search params (`?id=xxx`) or show root folders if none
  - [x] Fetch folder details using `folderService.getFolderDetails(folderId)`
  - [x] Display real subfolders and documents from API response
  - [x] Handle loading state with skeleton components
  - [x] Handle error state with error message and retry
  - [x] Update "New Document" button to navigate to editor with `folderId`
  - [x] Update document click to navigate to `/document?id={docId}`

- [x] **Task 8: Handle empty folder state** (AC: 8)

  - [x] Verify `DocumentList` empty state message displays correctly
  - [x] Ensure "New Document" button in empty state navigates to editor with `folderId`
  - [x] Style empty state consistently with design system

- [x] **Task 9: Wire up document navigation** (AC: 7)

  - [x] Update `DocumentList.onOpen` to use Next.js router to navigate
  - [x] Navigate to `/document?id={documentId}` on document click/double-click
  - [x] Verify document page accepts and uses the `id` param

## Dev Notes

### Critical Dependency

**Story 1.4 (Folder & Document CRUD API) is NOT fully complete.** Tasks 4-8 (services and routes) are still pending. The backend endpoints `/api/folders`, `/api/folders/:id`, `/api/documents/:id` must be implemented before this story can be fully tested.

**Recommendation:** Either complete Story 1.4 first, or implement this story with mock API responses that can be easily swapped.

### Previous Story Insights

[Source: docs/stories/1.5.story.md]

**From Story 1.5 - Auth & Frontend Foundation:**

- API client with auth headers exists at `apps/web/lib/api/client.ts`
- Auth service pattern established at `apps/web/lib/api/services/auth.ts`
- ProtectedRoute component wraps all pages requiring auth
- Sidebar integrated in AppShell with collapsible toggle
- Directory structure exists: `lib/api/services/`, `lib/contexts/`

**API Client Pattern:**

```typescript
import { apiClient } from "../client";

export const folderService = {
  async getFolderTree(): Promise<FoldersResponse> {
    return apiClient<FoldersResponse>("/folders");
  },

  async getFolderDetails(id: string): Promise<FolderDetailResponse> {
    return apiClient<FolderDetailResponse>(`/folders/${id}`);
  },
};
```

### API Endpoints

[Source: architecture/api-specification.md#Folder Endpoints]

| Method | Endpoint       | Purpose                          | Auth Required |
| ------ | -------------- | -------------------------------- | ------------- |
| GET    | `/folders`     | Get folder tree for current user | Yes           |
| GET    | `/folders/:id` | Get folder details with contents | Yes           |

```typescript
// GET /folders
interface FoldersResponse {
  folders: FolderTreeNode[];
}

// GET /folders/:id
interface FolderDetailResponse {
  folder: Folder;
  breadcrumbs: { id: string; name: string }[];
  subfolders: FolderWithMeta[];
  documents: DocumentSummary[];
}
```

### Data Models

[Source: architecture/data-models.md]

**FolderTreeNode:**

```typescript
interface FolderTreeNode {
  id: string;
  name: string;
  parentId: string | null;
  visibility: FolderVisibility;
  department: Department | null;
  documentCount: number;
  isAccessible: boolean;
  children: FolderTreeNode[];
}
```

**DocumentSummary:**

```typescript
interface DocumentSummary {
  id: string;
  title: string;
  folderId: string;
  folderPath: string;
  createdBy: PublicUser;
  updatedAt: Date;
  viewCount: number;
  commentCount: number;
}
```

**PublicUser:**

```typescript
type PublicUser = Pick<User, "id" | "displayName" | "department">;
```

### Existing Components (Need Updates)

[Source: apps/web/components/folder/]

| Component            | Current State                        | Updates Needed                                    |
| -------------------- | ------------------------------------ | ------------------------------------------------- |
| `FolderTree.tsx`     | Mock data, expand/collapse only      | Add folder click navigation, use API types        |
| `DocumentList.tsx`   | Mock data, `id: number`              | Use `id: string`, match `DocumentSummary` type    |
| `Breadcrumbs.tsx`    | Takes `path: string[]`               | Take `breadcrumbs: { id, name }[]`, add nav       |
| `DocumentPreview.tsx`| Uses mock document structure         | Update to match `DocumentSummary` type            |

**Sidebar.tsx Current State:**

```typescript
// Currently hardcoded mock data - remove this
const folderTree = [
  { id: "sales", name: "Sales", count: 24, isAccessible: true, children: [...] },
  ...
]
```

### File Locations

[Source: architecture/project-structure.md, architecture/components.md]

```
apps/web/
├── app/
│   └── folder/page.tsx           # UPDATE: API integration, URL params
├── components/
│   ├── folder/
│   │   ├── FolderTree.tsx        # UPDATE: Props, navigation callback
│   │   ├── DocumentList.tsx      # UPDATE: Types to match API
│   │   ├── Breadcrumbs.tsx       # UPDATE: Props, navigation
│   │   └── DocumentPreview.tsx   # UPDATE: Types to match API
│   └── layout/
│       └── Sidebar.tsx           # UPDATE: Fetch from API, remove mock
├── lib/
│   └── api/
│       └── services/
│           ├── auth.ts           # EXISTS
│           ├── folders.ts        # NEW
│           ├── documents.ts      # NEW
│           └── index.ts          # NEW - barrel export
```

### Navigation Patterns

[Source: Next.js App Router conventions]

**URL Structure:**

- Folder browse: `/folder?id={folderId}` (no id = root folders)
- Document view: `/document?id={documentId}`
- Document edit: `/editor?id={documentId}`
- New document: `/editor?folderId={folderId}` (no document id = new)

**Navigation using Next.js:**

```typescript
import { useRouter, useSearchParams } from "next/navigation";

const router = useRouter();
const searchParams = useSearchParams();

const folderId = searchParams.get("id");

// Navigate to folder
router.push(`/folder?id=${folderId}`);

// Navigate to document
router.push(`/document?id=${documentId}`);
```

### Relative Time Formatting

Use built-in `Intl.RelativeTimeFormat` or a lightweight helper:

```typescript
function formatRelativeTime(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - new Date(date).getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return "Today";
  if (diffDays === 1) return "Yesterday";
  if (diffDays < 7) return `${diffDays} days ago`;
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
  return new Date(date).toLocaleDateString();
}
```

### Coding Standards

[Source: architecture/coding-standards.md]

| Rule         | Application                             |
| ------------ | --------------------------------------- |
| Components   | PascalCase (`FolderTree.tsx`)           |
| API Calls    | Use service layer, never fetch directly |
| Type Sharing | Import from `@simpleconf/shared`        |
| State        | React useState for local, Context for shared |

### Testing

[Source: architecture/testing-strategy.md]

**Test Location:** `apps/web/__tests__/`

**Testing Framework:** Vitest + React Testing Library

**Key Test Scenarios:**

- FolderTree renders folder hierarchy correctly
- FolderTree calls onFolderSelect when folder name clicked
- DocumentList displays document metadata correctly
- DocumentList calls onOpen when document clicked
- Sidebar shows loading state while fetching
- Folder page displays API data correctly
- Empty folder shows "No documents yet" message

## Change Log

| Date       | Version | Description           | Author         |
| ---------- | ------- | --------------------- | -------------- |
| 2025-12-23 | 0.1     | Initial draft created | Bob (SM Agent) |
| 2025-12-23 | 1.0     | Implementation complete | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No significant debugging required

### Completion Notes List

- Created folder and document API services following established auth service pattern
- Updated FolderTree to use shared types and support folder navigation callbacks
- Sidebar now fetches folder tree from API with loading/error states
- DocumentList updated to use DocumentSummary type with relative time formatting
- Breadcrumbs now supports object-based breadcrumbs with navigation
- Folder page fully integrated with API, supports subfolders display
- DocumentPreview updated to match DocumentSummary type
- All navigation wired up (folder selection, document open, new document)
- Empty folder state displays correctly with message
- Also completed Story 1.4 Tasks 4-8 (backend services/routes were already implemented but unchecked)
- Fixed login page 401 redirect issue in API client

### File List

**New Files:**
- `apps/web/lib/api/services/folders.ts`
- `apps/web/lib/api/services/documents.ts`
- `apps/web/lib/api/services/index.ts`

**Modified Files:**
- `apps/web/lib/api/client.ts` (fixed 401 redirect on auth pages)
- `apps/web/components/folder/FolderTree.tsx`
- `apps/web/components/folder/DocumentList.tsx`
- `apps/web/components/folder/Breadcrumbs.tsx`
- `apps/web/components/folder/DocumentPreview.tsx`
- `apps/web/components/layout/Sidebar.tsx`
- `apps/web/app/folder/page.tsx`
- `apps/web/lib/components/protected-route.tsx` (removed debug log)
- `apps/web/components/auth/LoginForm.tsx` (removed debug log)

---

## QA Results

<!-- To be filled by QA agent -->
